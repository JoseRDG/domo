<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Administración - Frases Domo</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
    h1 { text-align: center; }

    #loginForm { max-width: 400px; margin: 20px auto; background: #fff; padding: 15px; border-radius: 5px; border: 1px solid #ccc; }
    #loginForm input { width: calc(100% - 20px); padding: 8px; margin-bottom: 10px; font-size: 16px; }
    #loginForm button { width: 100%; padding: 10px; font-size: 16px; cursor: pointer; }

    #logoutBtn { float: right; margin-bottom: 10px; padding: 8px 12px; cursor: pointer; }

    .tabs { display: flex; flex-wrap: wrap; margin-bottom: 10px; cursor: pointer; }
    .tab { padding: 10px 20px; border: 1px solid #ccc; border-bottom: none; background: #eee; border-radius: 5px 5px 0 0; margin-right: 5px; margin-bottom: 5px; transition: 0.2s; flex: 1; text-align: center; }
    .tab.active { background: #fff; font-weight: bold; border-bottom: 1px solid #fff; }

    .tab-content { display: none; padding: 15px; border: 1px solid #ccc; border-radius: 0 5px 5px 5px; background: #fff; overflow-x: auto; }
    .tab-content.active { display: block; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 300px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eee; }
    button { padding: 5px 10px; margin: 2px; cursor: pointer; }

    @media (max-width: 600px) {
      .tabs { flex-direction: column; }
      .tab { margin-right: 0; }
      #logoutBtn { float: none; display: block; margin-bottom: 10px; }
    }
  </style>
</head>
<body>

<h1>Panel de Administración - Frases Domo</h1>

<div id="loginSection">
  <form id="loginForm">
    <h3>Login Operador/Admin</h3>
    <input type="email" id="email" placeholder="Email" required><br>
    <input type="password" id="password" placeholder="Contraseña" required><br>
    <button type="submit">Login</button>
  </form>
</div>

<div id="mainSection" style="display:none;">
  <button id="logoutBtn">Cerrar sesión</button>

  <div class="tabs">
    <div class="tab active" data-tab="recibidas">Frases Recibidas</div>
    <div class="tab" data-tab="aprobadas">Frases Aprobadas</div>
  </div>

  <div id="recibidas" class="tab-content active">
    <table>
      <thead>
        <tr>
          <th>Frase</th>
          <th></th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tablaRecibidas"></tbody>
    </table>
  </div>

  <div id="aprobadas" class="tab-content">
    <button id="exportCsvBtn">Exportar Aprobadas a CSV</button>
    <table>
      <thead>
        <tr>
          <th>Frase</th>
          <th>Fijar</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tablaAprobadas"></tbody>
    </table>
  </div>
</div>

<script type="module">
const API_URL = import.meta.env.VITE_API_URL;
let token = localStorage.getItem("token");

document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab).classList.add('active');
  });
});

// Login
const loginForm = document.getElementById("loginForm");
loginForm.addEventListener("submit", async e => {
  e.preventDefault();
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  try {
    const res = await fetch(`${API_URL}/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    });
    const data = await res.json();
    if (res.ok) {
      token = data.token;
      localStorage.setItem("token", token);
      document.getElementById("loginSection").style.display = "none";
      document.getElementById("mainSection").style.display = "block";
      cargarFrases();
    } else {
      alert(data.error || "Error de login");
    }
  } catch (err) { console.error(err); }
});

// Logout
document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.removeItem("token");
  token = null;
  document.getElementById("mainSection").style.display = "none";
  document.getElementById("loginSection").style.display = "block";
});

// Cargar frases
async function cargarFrases() {
  if (!token) return;
  try {
    const res = await fetch(`${API_URL}/frases`, { headers: { Authorization: "Bearer " + token } });
    const data = await res.json();
    if (!Array.isArray(data)) { console.error("Respuesta inválida:", data); return; }
    mostrarFrases(data);
  } catch (err) { console.error(err); }
}

function mostrarFrases(frases) {
  const recibidas = document.getElementById("tablaRecibidas");
  const aprobadas = document.getElementById("tablaAprobadas");
  recibidas.innerHTML = "";
  aprobadas.innerHTML = "";

  frases.forEach(f => {
    if (!f.aprobada) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${f.texto}</td>
                      <td><button onclick="aprobar(${f.id})">Aprobar</button></td>
                      <td><button onclick="eliminarAprobada(${f.id})">Rechazar</button></td>`;
      recibidas.appendChild(tr);
    } else {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${f.texto}</td>
                      <td><input type="checkbox" ${f.fijada ? "checked" : ""} onchange="fijar(${f.id}, this.checked)"></td>
                      <td><button onclick="eliminarAprobada(${f.id})">Eliminar</button></td>`;
      aprobadas.appendChild(tr);
    }
  });
}

// Acciones
async function aprobar(id) { await fetch(`${API_URL}/frases/${id}/aprobar`, { method: "PUT", headers: { Authorization: "Bearer " + token } }); cargarFrases(); }
async function eliminarAprobada(id) { if (!confirm("¿Seguro que deseas eliminar esta frase?")) return; await fetch(`${API_URL}/frases/${id}`, { method: "DELETE", headers: { Authorization: "Bearer " + token } }); cargarFrases(); }
async function fijar(id, checked) { await fetch(`${API_URL}/frases/${id}/fijar`, { method: "PUT", headers: { "Content-Type": "application/json", Authorization: "Bearer " + token }, body: JSON.stringify({ fijada: checked }) }); }

// Exportar CSV
document.getElementById("exportCsvBtn").addEventListener("click", async () => {
  if (!token) return;
  const res = await fetch(`${API_URL}/frases`, { headers: { Authorization: "Bearer " + token } });
  const data = await res.json();
  const csv = ["id,texto,fijada,fecha", ...data.filter(f => f.aprobada).map(f => `${f.id},"${f.texto}",${f.fijada},${f.fecha}`)].join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "frases_aprobadas.csv";
  link.click();
});

// Mantener sesión
if (token) { document.getElementById("loginSection").style.display = "none"; document.getElementById("mainSection").style.display = "block"; cargarFrases(); }
</script>
</body>
</html>